{"version":3,"file":"recordings_plain.min.js","sources":["../src/recordings_plain.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JS for handling actions in the plain recordings table.\n *\n * @module      mod_bigbluebuttonbn/recordings_plain\n * @copyright   2025 Blindside Networks Inc\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as repository from './repository';\nimport { exception as displayException, saveCancelPromise } from 'core/notification';\nimport { getString } from 'core/str';\nimport { logMessage } from './_utils';\n\n/**\n * Handles an action (e.g., delete, publish, unpublish, lock, etc.) for a recording.\n *\n * @param {HTMLElement} element The clicked action button\n * @returns {Promise}\n */\nconst requestPlainAction = async(element) => {\n    const getDataFromAction = (element, dataType) => {\n        const dataElement = element.closest(`[data-${dataType}]`);\n        if (dataElement) {\n            return dataElement.dataset[dataType];\n        }\n\n        return null;\n    };\n\n    const elementData = element.dataset;\n    const payload = {\n        bigbluebuttonbnid: getDataFromAction(element, 'bbbid'),\n        recordingid: getDataFromAction(element, 'recordingid'),\n        additionaloptions: getDataFromAction(element, 'additionaloptions'),\n        action: elementData.action,\n    };\n    logMessage(payload);\n\n    // Slight change for import, for additional options.\n    if (!payload.additionaloptions) {\n        payload.additionaloptions = {};\n    }\n    if (elementData.action === 'import') {\n        const bbbsourceid = getDataFromAction(element, 'source-instance-id');\n        const bbbcourseid = getDataFromAction(element, 'source-course-id');\n        if (!payload.additionaloptions) {\n            payload.additionaloptions = {};\n        }\n        payload.additionaloptions.sourceid = bbbsourceid ? bbbsourceid : 0;\n        payload.additionaloptions.bbbcourseid = bbbcourseid ? bbbcourseid : 0;\n    }\n    // Now additional options should be a json string.\n    payload.additionaloptions = JSON.stringify(payload.additionaloptions);\n    if (element.dataset.requireConfirmation === \"1\") {\n        // Create the confirmation dialogue.\n        try {\n            await saveCancelPromise(\n                getString('confirm'),\n                await getRecordingConfirmationMessage(payload),\n                getString('ok', 'moodle'),\n            );\n        } catch {\n            // User cancelled the dialogue.\n            return;\n        }\n    }\n\n    return repository.updateRecording(payload)\n        .then(() => refreshPlainTable())\n        .catch(displayException);\n};\n\n/**\n * Generates a confirmation message for recording actions.\n *\n * @param {Object} data The recording action data\n * @returns {Promise<string>}\n */\nconst getRecordingConfirmationMessage = async (data) => {\n\n    logMessage(data);\n\n    const playbackElement = document.querySelector(`#playbacks-${data.recordingid}`);\n\n    if (!playbackElement) {\n        // Fallback if the element is missing\n        return getString(`view_recording_${data.action}_confirmation`, 'bigbluebuttonbn');\n    }\n\n    // Determine recording type (imported or regular)\n    const recordingType = await getString(\n        playbackElement.dataset.imported === 'true' ? 'view_recording_link' : 'view_recording',\n        'bigbluebuttonbn'\n    );\n\n    // Get base confirmation message\n    const confirmation = await getString(\n        `view_recording_${data.action}_confirmation`,\n        'bigbluebuttonbn',\n        recordingType\n    );\n\n    if (data.action === 'import') {\n        return confirmation; // No additional warnings needed\n    }\n\n    // Handle associated links\n    const associatedLinkCount = document.querySelector(`a#recording-${data.action}-${data.recordingid}`)?.dataset?.links;\n\n    if (!associatedLinkCount || associatedLinkCount === \"0\") {\n        return confirmation; // No warnings needed\n    }\n\n    // Fetch warning message based on link count\n    const confirmationWarning = await getString(\n        associatedLinkCount === \"1\"\n            ? `view_recording_${data.action}_confirmation_warning_p`\n            : `view_recording_${data.action}_confirmation_warning_s`,\n        'bigbluebuttonbn',\n        associatedLinkCount\n    );\n\n    return `${confirmationWarning}\\n\\n${confirmation}`;\n};\n\n/**\n * Refreshes the plain recordings table by reloading the page.\n */\nconst refreshPlainTable = () => {\n    window.location.reload(); // Refresh page to update the table\n};\n\nconst registerPlainRecordingListeners = () => {\n    document.addEventListener('click', (e) => {\n        logMessage(\"registerPlainRecordingListeners.\");\n        const actionButton = e.target.closest('.action-icon');\n        if (actionButton) {\n            e.preventDefault();\n            requestPlainAction(actionButton);\n            return;\n        }\n\n        // Detect sortable column click\n        const sortableHeader = e.target.closest(\".sortable-header\");\n        if (sortableHeader) {\n            const column = sortableHeader.dataset.sort;\n            e.preventDefault();\n            sortTable(column);\n        }\n    });\n};\n\nregisterPlainRecordingListeners();\n\n// Sorting functionality\nlet sortOrders = { name: true, description: true, date: true }; // Track sorting state for each column\n\nconst sortTable = (column) => {\n    const tableContainer = document.querySelector(\".mod_bigbluebuttonbn_recordings_table_plain\");\n\n    if (!tableContainer) {\n        return;\n    }\n\n    const rows = Array.from(tableContainer.querySelectorAll(\".row.mb-3.align-items-center\"));\n\n    rows.sort((rowA, rowB) => {\n        let valueA, valueB;\n\n        if (column === \"date\") {\n            const dateAElement = rowA.querySelector(\".col-md-2[data-sort='date']\");\n            const dateBElement = rowB.querySelector(\".col-md-2[data-sort='date']\");\n\n            if (!dateAElement || !dateBElement) {\n                return 0;\n            }\n\n            const dateA = parseDate(dateAElement.textContent.trim());\n            const dateB = parseDate(dateBElement.textContent.trim());\n\n            return sortOrders[column] ? dateA - dateB : dateB - dateA;\n        } else {\n            const columnSelector = `.col-md-${column === \"name\" ? 1 : 2}[data-sort='${column}']`;\n            const elementA = rowA.querySelector(columnSelector);\n            const elementB = rowB.querySelector(columnSelector);\n\n            if (!elementA || !elementB) {\n                return 0;\n            }\n\n            valueA = elementA.textContent.trim().toLowerCase();\n            valueB = elementB.textContent.trim().toLowerCase();\n\n            return sortOrders[column] ? valueA.localeCompare(valueB) : valueB.localeCompare(valueA);\n        }\n    });\n\n    rows.forEach(row => {\n        tableContainer.appendChild(row);\n    });\n\n    sortOrders[column] = !sortOrders[column];\n\n    updateSortIcons(column);\n};\n\nconst parseDate = (dateString) => {\n    const parsedDate = Date.parse(dateString);\n    return isNaN(parsedDate) ? 0 : parsedDate; // Convert to timestamp for comparison\n};\n\nconst updateSortIcons = (activeColumn) => {\n    document.querySelectorAll(\".sortable-header .sort-icon\").forEach(icon => {\n        icon.textContent = \"▲\"; // Reset all icons to default ascending\n    });\n\n    const activeHeader = document.querySelector(`.sortable-header[data-sort=\"${activeColumn}\"] .sort-icon`);\n\n    if (activeHeader) {\n        activeHeader.textContent = sortOrders[activeColumn] ? \"▲\" : \"▼\";\n    }\n};\n"],"names":["getRecordingConfirmationMessage","async","data","playbackElement","document","querySelector","recordingid","action","recordingType","dataset","imported","confirmation","associatedLinkCount","_document$querySelect","_document$querySelect2","links","confirmationWarning","refreshPlainTable","window","location","reload","addEventListener","e","actionButton","target","closest","preventDefault","getDataFromAction","element","dataType","dataElement","elementData","payload","bigbluebuttonbnid","additionaloptions","bbbsourceid","bbbcourseid","sourceid","JSON","stringify","requireConfirmation","repository","updateRecording","then","catch","displayException","requestPlainAction","sortableHeader","column","sort","sortTable","sortOrders","name","description","date","tableContainer","rows","Array","from","querySelectorAll","rowA","rowB","valueA","valueB","dateAElement","dateBElement","dateA","parseDate","textContent","trim","dateB","columnSelector","elementA","elementB","toLowerCase","localeCompare","forEach","row","appendChild","updateSortIcons","dateString","parsedDate","Date","parse","isNaN","activeColumn","icon","activeHeader"],"mappings":";;;;;;;wBA6FMA,gCAAkCC,MAAAA,8EAEzBC,YAELC,gBAAkBC,SAASC,mCAA4BH,KAAKI,kBAE7DH,uBAEM,2CAA4BD,KAAKK,wBAAuB,yBAI7DC,oBAAsB,kBACa,SAArCL,gBAAgBM,QAAQC,SAAsB,sBAAwB,iBACtE,mBAIEC,mBAAqB,2CACLT,KAAKK,wBACvB,kBACAC,kBAGgB,WAAhBN,KAAKK,cACEI,mBAILC,kDAAsBR,SAASC,oCAA6BH,KAAKK,mBAAUL,KAAKI,+EAA1DO,sBAA0EJ,iDAA1EK,uBAAmFC,UAE1GH,qBAA+C,MAAxBA,2BACjBD,mBAILK,0BAA4B,2CAENd,KAAKK,OADL,MAAxBK,yEAGA,kBACAA,qCAGMI,mCAA0BL,eAMlCM,kBAAoB,KACtBC,OAAOC,SAASC,UAIhBhB,SAASiB,iBAAiB,SAAUC,0BACrB,0CACLC,aAAeD,EAAEE,OAAOC,QAAQ,mBAClCF,oBACAD,EAAEI,qBAtHazB,OAAAA,gBACjB0B,kBAAoB,CAACC,QAASC,kBAC1BC,YAAcF,QAAQH,wBAAiBI,sBACzCC,YACOA,YAAYrB,QAAQoB,UAGxB,MAGLE,YAAcH,QAAQnB,QACtBuB,QAAU,CACZC,kBAAmBN,kBAAkBC,QAAS,SAC9CtB,YAAaqB,kBAAkBC,QAAS,eACxCM,kBAAmBP,kBAAkBC,QAAS,qBAC9CrB,OAAQwB,YAAYxB,iCAEbyB,SAGNA,QAAQE,oBACTF,QAAQE,kBAAoB,IAEL,WAAvBH,YAAYxB,OAAqB,OAC3B4B,YAAcR,kBAAkBC,QAAS,sBACzCQ,YAAcT,kBAAkBC,QAAS,oBAC1CI,QAAQE,oBACTF,QAAQE,kBAAoB,IAEhCF,QAAQE,kBAAkBG,SAAWF,aAA4B,EACjEH,QAAQE,kBAAkBE,YAAcA,aAA4B,KAGxEJ,QAAQE,kBAAoBI,KAAKC,UAAUP,QAAQE,mBACP,MAAxCN,QAAQnB,QAAQ+B,8BAGN,oCACF,kBAAU,iBACJxC,gCAAgCgC,UACtC,kBAAU,KAAM,WAEtB,aAMCS,WAAWC,gBAAgBV,SAC7BW,MAAK,IAAM1B,sBACX2B,MAAMC,0BAqEHC,CAAmBvB,oBAKjBwB,eAAiBzB,EAAEE,OAAOC,QAAQ,uBACpCsB,eAAgB,OACVC,OAASD,eAAetC,QAAQwC,KACtC3B,EAAEI,iBACFwB,UAAUF,gBAQlBG,WAAa,CAAEC,MAAM,EAAMC,aAAa,EAAMC,MAAM,SAElDJ,UAAaF,eACTO,eAAiBnD,SAASC,cAAc,mDAEzCkD,4BAICC,KAAOC,MAAMC,KAAKH,eAAeI,iBAAiB,iCAExDH,KAAKP,MAAK,CAACW,KAAMC,YACTC,OAAQC,UAEG,SAAXf,OAAmB,OACbgB,aAAeJ,KAAKvD,cAAc,+BAClC4D,aAAeJ,KAAKxD,cAAc,mCAEnC2D,eAAiBC,oBACX,QAGLC,MAAQC,UAAUH,aAAaI,YAAYC,QAC3CC,MAAQH,UAAUF,aAAaG,YAAYC,eAE1ClB,WAAWH,QAAUkB,MAAQI,MAAQA,MAAQJ,MACjD,OACGK,iCAAuC,SAAXvB,OAAoB,EAAI,yBAAgBA,aACpEwB,SAAWZ,KAAKvD,cAAckE,gBAC9BE,SAAWZ,KAAKxD,cAAckE,uBAE/BC,UAAaC,UAIlBX,OAASU,SAASJ,YAAYC,OAAOK,cACrCX,OAASU,SAASL,YAAYC,OAAOK,cAE9BvB,WAAWH,QAAUc,OAAOa,cAAcZ,QAAUA,OAAOY,cAAcb,SANrE,MAUnBN,KAAKoB,SAAQC,MACTtB,eAAeuB,YAAYD,QAG/B1B,WAAWH,SAAWG,WAAWH,QAEjC+B,gBAAgB/B,SAGdmB,UAAaa,mBACTC,WAAaC,KAAKC,MAAMH,mBACvBI,MAAMH,YAAc,EAAIA,YAG7BF,gBAAmBM,eACrBjF,SAASuD,iBAAiB,+BAA+BiB,SAAQU,OAC7DA,KAAKlB,YAAc,aAGjBmB,aAAenF,SAASC,oDAA6CgF,+BAEvEE,eACAA,aAAanB,YAAcjB,WAAWkC,cAAgB,IAAM"}